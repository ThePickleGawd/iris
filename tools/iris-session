#!/usr/bin/env bash
# tools/iris-session â€” Launch a claude-commander session for Iris.
#
# Usage:
#   tools/iris-session                         # new session
#   tools/iris-session --resume <session_id>   # resume existing session
#   tools/iris-session --cwd /some/project     # specify working directory
#
# Environment:
#   IRIS_BACKEND_URL   Backend base URL (default: http://localhost:8000)
#   CLAUDE_CMD         Claude Code binary (default: claude)
#   CLAUDEC_BIN        claude-commander binary (default: claudec)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

IRIS_BACKEND_URL="${IRIS_BACKEND_URL:-http://localhost:8000}"
CLAUDEC_BIN="${CLAUDEC_BIN:-claudec}"
SOCKET_PATH="/tmp/iris-claude.sock"
META_FILE="/tmp/iris-claude-meta.json"
IMAGES_DIR="/tmp/iris/images"

# Parse arguments
CWD="${PROJECT_ROOT}"
RESUME_ID=""
EXTRA_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --resume)
            RESUME_ID="$2"
            shift 2
            ;;
        --cwd)
            CWD="$2"
            shift 2
            ;;
        *)
            EXTRA_ARGS+=("$1")
            shift
            ;;
    esac
done

# Ensure images directory exists for the image pipeline
mkdir -p "$IMAGES_DIR"

# Check for claudec binary
if ! command -v "$CLAUDEC_BIN" &>/dev/null; then
    echo "ERROR: claude-commander ($CLAUDEC_BIN) not found."
    echo ""
    echo "Install it:"
    echo "  curl -L https://github.com/sstraus/claude-commander/releases/latest/download/claudec-macos-arm64 -o /usr/local/bin/claudec"
    echo "  chmod +x /usr/local/bin/claudec"
    echo ""
    echo "Or build from source:"
    echo "  cargo install --git https://github.com/sstraus/claude-commander"
    exit 1
fi

# Clean up stale socket
if [[ -S "$SOCKET_PATH" ]]; then
    echo "Removing stale socket at $SOCKET_PATH"
    rm -f "$SOCKET_PATH"
fi

# Set the fixed socket path (avoids claude-commander's session ID detection + Unicode bug)
export CLAUDE_SOCKET="$SOCKET_PATH"

# Build claudec args
CLAUDEC_ARGS=(-d "$CWD")
if [[ -n "$RESUME_ID" ]]; then
    CLAUDEC_ARGS+=(--resume "$RESUME_ID")
fi
CLAUDEC_ARGS+=("${EXTRA_ARGS[@]}")

# Write meta file before launching so the backend can discover the socket
cat > "$META_FILE" <<EOF
{
    "socket_path": "$SOCKET_PATH",
    "pid": $$,
    "cwd": "$CWD",
    "resume_id": "${RESUME_ID:-null}",
    "started_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF

echo "Iris Claude Code session"
echo "  Socket:  $SOCKET_PATH"
echo "  CWD:     $CWD"
echo "  Meta:    $META_FILE"
[[ -n "$RESUME_ID" ]] && echo "  Resume:  $RESUME_ID"
echo ""

# Notify backend that a live session is starting
curl -sf -X POST "$IRIS_BACKEND_URL/api/claude-code/sessions/register" \
    -H "Content-Type: application/json" \
    -d "{\"socket_path\": \"$SOCKET_PATH\", \"cwd\": \"$CWD\", \"pid\": $$}" \
    2>/dev/null || true

# Cleanup on exit
cleanup() {
    echo ""
    echo "Cleaning up Iris session..."
    rm -f "$SOCKET_PATH" "$META_FILE"
    # Notify backend the session ended
    curl -sf -X POST "$IRIS_BACKEND_URL/api/claude-code/sessions/unregister" \
        -H "Content-Type: application/json" \
        -d "{\"socket_path\": \"$SOCKET_PATH\"}" \
        2>/dev/null || true
}
trap cleanup EXIT INT TERM

# Launch claude-commander
exec "$CLAUDEC_BIN" "${CLAUDEC_ARGS[@]}"
